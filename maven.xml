<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE project >
<project xmlns:j="jelly:core" xmlns:u="jelly:util" xmlns:ant="jelly:ant" default="rebuild-all">
    <goal name="rebuild-all" prereqs="pom,clean,war:war,dist:build" />
    <postGoal name="site">
        <attainGoal name="pdf" />
    </postGoal>
	
    <preGoal name="jar:jar">
        <!-- add tlds to taglib jar -->
        <j:set var="tld.dir" value="${maven.src.dir}/webapp/WEB-INF/taglib" />
        <ant:echo message="copying tld files ${tld.dir} to ${maven.build.dest}/META-INF" />
        <ant:copy todir="${maven.build.dest}/META-INF">
            <fileset dir="${tld.dir}">
                <include name="*.tld" />
            </fileset>
        </ant:copy>
    </preGoal>
	
	<postGoal name="war:war-resources">
		<j:set var="instanceName" value="${magnolia.build.instance}"/>
		<j:if test="${instanceName == 'public'}">
			<ant:replace file="${maven.war.webapp.dir}/WEB-INF/web.xml" token="&lt;param-value&gt;magnolia.root&lt;/param-value&gt;" value="&lt;param-value&gt;magnolia.public.root&lt;/param-value&gt;"/>

			<ant:replace file="${maven.war.webapp.dir}/WEB-INF/config/log4j.xml" token="$${magnolia.root}" value="$${magnolia.public.root}"/>
		
			<ant:replace file="${maven.war.webapp.dir}/WEB-INF/config/repositories.xml" token="Author" value="Public"/>
			<ant:replace file="${maven.war.webapp.dir}/WEB-INF/config/repositories.xml" token="jackrabbit-cqfs-nosearch.xml" value="jackrabbit-file-search.xml"/>

			<!-- we should use xslt to manipulate the xml files -->
			<!-- unfortunately maven does not know the replacetoken and replacevalue tags -->
	    		<ant:replace file="${maven.war.webapp.dir}/WEB-INF/bootstrap/config/config.server.xml"
	    			token="&lt;sv:property sv:name=&quot;URI&quot; sv:type=&quot;String&quot;&gt;&lt;sv:value&gt;/*&lt;/sv:value&gt;&lt;/sv:property&gt;"
	    			value="&lt;sv:property sv:name=&quot;URI&quot; sv:type=&quot;String&quot;&gt;&lt;sv:value&gt;/.magnolia/*&lt;/sv:value&gt;&lt;/sv:property&gt;"
	    		/>	
	
	    		<ant:replace file="${maven.war.webapp.dir}/WEB-INF/bootstrap/config/config.server.xml"
				token="&lt;sv:property sv:name=&quot;admin&quot; sv:type=&quot;String&quot;&gt;&lt;sv:value&gt;true&lt;/sv:value&gt;&lt;/sv:property&gt;"
				value="&lt;sv:property sv:name=&quot;admin&quot; sv:type=&quot;String&quot;&gt;&lt;sv:value&gt;false&lt;/sv:value&gt;&lt;/sv:property&gt;"
			/>	
	
			<ant:replace file="${maven.war.webapp.dir}/WEB-INF/bootstrap/config/config.server.xml"
				token="&lt;sv:property sv:name=&quot;ResourceNotAvailableURIMapping&quot; sv:type=&quot;String&quot;&gt;&lt;sv:value&gt;/.magnolia/adminCentral.html&lt;/sv:value&gt;&lt;/sv:property&gt;"
				value="&lt;sv:property sv:name=&quot;ResourceNotAvailableURIMapping&quot; sv:type=&quot;String&quot;&gt;&lt;sv:value&gt;/features.html&lt;/sv:value&gt;&lt;/sv:property&gt;"
			/>
		</j:if>
		<j:if test="${instanceName == 'author'}">
			<ant:replace file="${maven.war.webapp.dir}/WEB-INF/bootstrap/config/config.subscribers.xml"
				token="&lt;sv:property sv:name=&quot;active&quot; sv:type=&quot;String&quot;&gt;&lt;sv:value&gt;false&lt;/sv:value&gt;&lt;/sv:property&gt;"
				value="&lt;sv:property sv:name=&quot;active&quot; sv:type=&quot;String&quot;&gt;&lt;sv:value&gt;true&lt;/sv:value&gt;&lt;/sv:property&gt;"
			/>
		</j:if>
	
	</postGoal>
	

    <goal name="nightly" prereqs="clean,war:war,site:generate,copy-nightly-war,site:sshdeploy">
    </goal>

    <goal name="copy-nightly-war">
        <ant:copy todir="${maven.build.dir}/docs/nightly">
            <fileset dir="${maven.build.dir}">
                <include name="*.war" />
            </fileset>
        </ant:copy>
    </goal>

    <!-- can be useful when working with IDEs -->
    <goal name="copylibs">
        <j:forEach var="lib" items="${pom.artifacts}">
            <j:set var="dep" value="${lib.dependency}" />
            <j:if test="${dep.getProperty('war.bundle')=='true'}">
            <j:if test="${dep.getProperty('eclipse.dependency')!='true'}">
	                <j:if test="${dep.type =='jar'}">
	                    <ant:copy todir="${basedir}/src/webapp/WEB-INF/lib" file="${lib.path}" />
	                </j:if>
                </j:if>
            </j:if>
        </j:forEach>
    </goal>
	
	<!-- convert the java properties files to a readable utf8 format -->
	<goal name="java2utf8">
		<ant:native2ascii src="src/resources/info/magnolia/module/admininterface" dest="src/resources/info/magnolia/module/admininterface/utf8" ext=".txt" encoding="UTF8" reverse="true"/>
	</goal>

	<!-- convert the utf8 properties files to the java format -->
	<goal name="utf82ascii">
		<ant:native2ascii src="src/resources/info/magnolia/module/admininterface/utf8" dest="src/resources/info/magnolia/module/admininterface" ext=".properties" encoding="UTF8"/>
	</goal>

	
</project>